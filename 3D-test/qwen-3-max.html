<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手勢控制3D粒子系統</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #e0e0ff;
            height: 100vh;
            width: 100vw;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #video-container {
            display: none;
        }
        
        #controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 12, 41, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            width: 280px;
            transition: all 0.3s ease;
        }
        
        #controls:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #8a7bff;
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .control-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #a6b1ff;
            font-size: 0.95rem;
        }
        
        select, input[type="color"] {
            width: 100%;
            padding: 10px 15px;
            background: rgba(30, 25, 80, 0.7);
            border: 1px solid rgba(138, 123, 255, 0.4);
            border-radius: 10px;
            color: #e0e0ff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }
        
        select:focus, input[type="color"]:focus {
            border-color: #8a7bff;
            box-shadow: 0 0 0 3px rgba(138, 123, 255, 0.3);
        }
        
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23a6b1ff' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(30, 25, 80, 0.6);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ff6b6b;
        }
        
        .status-dot.active {
            background: #4ade80;
            box-shadow: 0 0 8px #4ade80;
        }
        
        .instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(30, 25, 80, 0.5);
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin-top: 8px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        footer {
            position: fixed;
            bottom: 15px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.85rem;
            color: rgba(200, 200, 255, 0.7);
            z-index: 100;
            padding: 0 20px;
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(138, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(138, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 123, 255, 0); }
        }
        
        @media (max-width: 768px) {
            #controls {
                width: 90%;
                right: 50%;
                transform: translateX(50%);
                top: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>
    
    <div id="controls">
        <h1>✨ 3D 粒子控制器</h1>
        
        <div class="control-group">
            <label for="shape-select">粒子形狀</label>
            <select id="shape-select">
                <option value="circle">圓形</option>
                <option value="heart">愛心</option>
                <option value="flower">花朵</option>
                <option value="saturn">土星</option>
                <option value="firework">煙火</option>
                <option value="star">星星</option>
                <option value="snowflake">雪花</option>
            </select>
        </div>
        
        <div class="control-group">
            <label for="color-picker">粒子顏色</label>
            <input type="color" id="color-picker" value="#8a7bff">
        </div>
        
        <div class="status">
            <span class="status-dot" id="hands-status"></span>
            <span>等待手勢偵測中...</span>
        </div>
        
        <div class="instructions">
            <strong>操作說明：</strong>
            <ul>
                <li>✋ 張開手掌：擴散粒子</li>
                <li>✊ 握拳：收縮粒子</li>
                <li>使用網路攝影機啟用控制</li>
            </ul>
        </div>
    </div>
    
    <footer>
        <span>手勢控制3D粒子系統 | 使用 Three.js 與 MediaPipe Hands</span>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 全域變數
            let scene, camera, renderer, particles;
            let hands, cameraUtils;
            let isHandsDetected = false;
            let currentScale = 1.0;
            let targetScale = 1.0;
            let particleCount = 5000;
            let particleGeometry, particleMaterial;
            let currentShape = 'circle';
            let currentColor = '#8a7bff';
            let handStates = [false, false]; // 用於追蹤每隻手是張開(false)還是握拳(true)
            
            // 初始化Three.js場景
            function initThreeJS() {
                // 建立場景
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x0a0515);
                scene.fog = new THREE.FogExp2(0x0a0515, 0.001);
                
                // 建立相機
                camera = new THREE.PerspectiveCamera(
                    75, 
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    1000
                );
                camera.position.z = 5;
                
                // 建立渲染器
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                document.getElementById('canvas-container').appendChild(renderer.domElement);
                
                // 光源
                const ambientLight = new THREE.AmbientLight(0x4040ff, 0.5);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0x8a7bff, 1);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // 建立粒子系統
                createParticles();
                
                // 視窗大小調整
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            
            // 建立粒子系統
            function createParticles() {
                // 刪除現有的粒子
                if (particles) scene.remove(particles);
                
                // 建立幾何體
                particleGeometry = new THREE.BufferGeometry();
                
                // 產生粒子位置
                const positions = new Float32Array(particleCount * 3);
                const scales = new Float32Array(particleCount);
                
                for (let i = 0; i < particleCount * 3; i += 3) {
                    // 隨機位置在球體內
                    const radius = 2.5 + Math.random() * 0.5;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    
                    positions[i] = radius * Math.sin(phi) * Math.cos(theta);
                    positions[i + 1] = radius * Math.sin(phi) * Math.sin(theta);
                    positions[i + 2] = radius * Math.cos(phi);
                    
                    // 隨機大小
                    scales[i / 3] = 0.5 + Math.random();
                }
                
                particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                particleGeometry.setAttribute('scale', new THREE.BufferAttribute(scales, 1));
                
                // 建立材質
                const textureLoader = new THREE.TextureLoader();
                let sprite;
                
                // 根據選擇的形狀載入對應的紋理
                switch (currentShape) {
                    case 'heart':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="white" d="M50 15C30 15 15 30 15 50c0 15 7.5 25 20 30 12.5-5 20-15 20-30s-7.5-25-20-30z"/></svg>');
                        break;
                    case 'flower':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="20" fill="white"/><circle cx="30" cy="30" r="10" fill="white"/><circle cx="70" cy="30" r="10" fill="white"/><circle cx="30" cy="70" r="10" fill="white"/><circle cx="70" cy="70" r="10" fill="white"/></svg>');
                        break;
                    case 'saturn':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="15" fill="white"/><ellipse cx="50" cy="50" rx="40" ry="10" fill="none" stroke="white" stroke-width="3"/></svg>');
                        break;
                    case 'firework':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="white" d="M50 15L45 45H15L45 55L50 85L55 55H85L55 45L50 15Z"/></svg>');
                        break;
                    case 'star':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="white" d="M50 5L61 38H98L71 59L82 92L50 75L18 92L29 59L2 38H39L50 5Z"/></svg>');
                        break;
                    case 'snowflake':
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="white" d="M50 10L45 40H20L40 50L20 60H45L50 90L55 60H80L60 50L80 40H55L50 10Z"/></svg>');
                        break;
                    default: // circle
                        sprite = textureLoader.load('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="white"/></svg>');
                }
                
                particleMaterial = new THREE.PointsMaterial({
                    size: 0.15,
                    sizeAttenuation: true,
                    map: sprite,
                    transparent: true,
                    depthWrite: false,
                    blending: THREE.AdditiveBlending,
                    color: currentColor
                });
                
                // 建立粒子系統
                particles = new THREE.Points(particleGeometry, particleMaterial);
                scene.add(particles);
            }
            
            // 初始化MediaPipe
            function initMediaPipe() {
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults(onResults);
                
                // 設定相機
                const webcam = document.getElementById('webcam');
                cameraUtils = new Camera(webcam, {
                    onFrame: async () => {
                        await hands.send({ image: webcam });
                    },
                    width: 640,
                    height: 480
                });
                
                cameraUtils.start();
            }
            
            // 處理MediaPipe結果
            function onResults(results) {
                if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                    isHandsDetected = false;
                    document.getElementById('hands-status').className = 'status-dot';
                    document.querySelector('.status span').textContent = '等待手勢偵測中...';
                    handStates = [false, false];
                    return;
                }
                
                isHandsDetected = true;
                document.getElementById('hands-status').className = 'status-dot active';
                document.querySelector('.status span').textContent = `偵測到 ${results.multiHandLandmarks.length} 隻手`;
                
                let gripDetected = false;
                
                // 檢查每隻手
                for (let i = 0; i < Math.min(2, results.multiHandLandmarks.length); i++) {
                    const landmarks = results.multiHandLandmarks[i];
                    
                    // 檢查是否握拳 - 比較指尖到手腕的距離
                    const wrist = landmarks[0];
                    const indexTip = landmarks[8];
                    const middleTip = landmarks[12];
                    
                    const indexDist = Math.hypot(
                        indexTip.x - wrist.x,
                        indexTip.y - wrist.y,
                        indexTip.z - wrist.z
                    );
                    
                    const middleDist = Math.hypot(
                        middleTip.x - wrist.x,
                        middleTip.y - wrist.y,
                        middleTip.z - wrist.z
                    );
                    
                    // 如果兩個指尖都靠近手腕，視為握拳
                    if (indexDist < 0.15 && middleDist < 0.15) {
                        handStates[i] = true;
                        gripDetected = true;
                    } else {
                        handStates[i] = false;
                    }
                }
                
                // 設定目標縮放比例 - 任何一隻手握拳都會觸發收縮
                targetScale = gripDetected ? 0.3 : 2.0;
            }
            
            // 動畫循環
            function animate() {
                requestAnimationFrame(animate);
                
                // 平滑過渡縮放
                currentScale += (targetScale - currentScale) * 0.08;
                particles.scale.set(currentScale, currentScale, currentScale);
                
                // 讓粒子緩慢旋轉
                if (particles) {
                    particles.rotation.y += 0.001;
                    particles.rotation.x += 0.0005;
                }
                
                renderer.render(scene, camera);
            }
            
            // 設定控制事件
            function setupControls() {
                document.getElementById('shape-select').addEventListener('change', (e) => {
                    currentShape = e.target.value;
                    createParticles();
                });
                
                document.getElementById('color-picker').addEventListener('input', (e) => {
                    currentColor = e.target.value;
                    if (particleMaterial) {
                        particleMaterial.color.set(currentColor);
                    }
                });
            }
            
            // 初始化應用
            async function init() {
                initThreeJS();
                setupControls();
                
                // 嘗試初始化MediaPipe
                try {
                    await initMediaPipe();
                } catch (error) {
                    console.error('無法初始化MediaPipe:', error);
                    document.getElementById('hands-status').className = 'status-dot';
                    document.querySelector('.status span').textContent = '無法存取相機';
                }
                
                // 開始動畫循環
                animate();
            }
            
            // 開始初始化
            init();
        });
    </script>
</body>
</html>